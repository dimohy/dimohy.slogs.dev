---
title: "ì—”í‹°í‹° í”„ë ˆì„ì›Œí¬ ì½”ì–´ë¡œ ì†Œí”„íŠ¸ ì‚­ì œ ì „ëµì„ êµ¬í˜„í•˜ëŠ” ë°©ë²• | Khalid Abuhakmeh"
datePublished: Fri Jun 16 2023 05:44:43 GMT+0000 (Coordinated Universal Time)
cuid: cliy5av4x000a09l6319h25r1
slug: how-to-implement-a-soft-delete-strategy-with-entity-framework-core
canonical: https://blog.jetbrains.com/dotnet/2023/06/14/how-to-implement-a-soft-delete-strategy-with-entity-framework-core/
tags: net, dotnet, efcore

---

> [Khalid Abuhakmeh](https://blog.jetbrains.com/author/khalid-abuhakmeh)ë‹˜ì˜ [https://blog.jetbrains.com/dotnet/2023/06/14/how-to-implement-a-soft-delete-strategy-with-entity-framework-core/](https://blog.jetbrains.com/dotnet/2023/06/14/how-to-implement-a-soft-delete-strategy-with-entity-framework-core/)ë¥¼ ë²ˆì—­í•˜ì˜€ìŠµë‹ˆë‹¤.

---

ê°œë°œ ê²½ë ¥ì„ ìŒ“ëŠ” ë™ì•ˆ 'ì‚­ì œ'ì˜ ì •ì˜ì— ëŒ€í•´ í˜¼ë€ìŠ¤ëŸ¬ì› ë˜ ê²½í—˜ì´ ìˆì„ ê²ƒì…ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ì‚¬ìš©ìê°€ "ë‚´ ë°ì´í„° **ì‚­ì œ**"ë¼ê³  ë§í•˜ëŠ” ê²ƒì€ ë¬´ì—‡ì„ ì˜ë¯¸í• ê¹Œìš”? ì €ì™€ ê°™ì€ ì‚¬ëŒì´ë¼ë©´ ì‚¬ìš©ìê°€ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ë¥¼ ì–´ì§€ëŸ½íˆëŠ” ì •ë³´ë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œí•˜ê³  ì‹¶ë‹¤ëŠ” ëœ»ì´ì§€, ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê¸°ë¡ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ê³  ì‹¶ë‹¤ëŠ” ëœ»ì´ **ì•„ë‹ˆë¼ëŠ” ê²ƒ**ì„ ê¸ˆë°© ì•Œ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤... ì›ìŠ¤ ğŸ˜¬.

ë§ì€ ê°œë°œìëŠ” ë¼ˆì•„í”ˆ êµí›ˆì„ ì–»ì€ í›„ ì‹¤ìˆ˜ë¡œ ì‚­ì œí•œ ë°ì´í„°ë¥¼ ë˜ëŒë¦¬ê³  ë°ì´í„° ë¬´ê²°ì„±ì„ ìœ ì§€í•˜ë©° ì¼ë°˜ì ì¸ ê´€ë¦¬ ê°ë…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” **ì†Œí”„íŠ¸ ì‚­ì œ** ì „ëµìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤. ë˜í•œ ë²•ì— ë”°ë¼ ì¼ì • ê¸°ê°„ ë™ì•ˆ ë°ì´í„°ë¥¼ ë³´ì¡´í•´ì•¼ í•  ìˆ˜ë„ ìˆëŠ”ë°, ì´ ì „ëµì€ ì´ëŸ¬í•œ ìš”ê±´ì„ ì¶©ì¡±í•˜ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê²Œì‹œë¬¼ì—ì„œëŠ” ì—”í‹°í‹° í”„ë ˆì„ì›Œí¬ ì½”ì–´ë¡œ **ì†Œí”„íŠ¸ ì‚­ì œ** ì „ëµì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ê³¼ ì„ íƒí•œ ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ì— ì“°ê³  ì½ëŠ” ë™ì•ˆ ì´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë´…ë‹ˆë‹¤.

## ì†Œí”„íŠ¸ ì‚­ì œë€ ë¬´ì—‡ì¸ê°€ìš”?

ì†Œê°œì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì—ëŠ” ë¬¼ë¦¬ì  ì‚­ì œì™€ ë…¼ë¦¬ì  ì‚­ì œì˜ ë‘ ê°€ì§€ ìœ í˜•ì´ ìˆìŠµë‹ˆë‹¤.

ë¬¼ë¦¬ì  ì‚­ì œëŠ” ë°ì´í„° ì €ì¥ì†Œì—ì„œ ë ˆì½”ë“œë¥¼ ì œê±°í•˜ë©° ë§¤ìš° íŒŒê´´ì ì…ë‹ˆë‹¤. ë¬¼ë¦¬ì  ì‚­ì œë¥¼ í†µí•´ ì‚­ì œëœ ë°ì´í„°ëŠ” ì†ì‹¤ë˜ë©°, ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ ê·¹ë‹¨ì ì¸ ì¡°ì¹˜ë‚˜ ë°±ì—…ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬¼ë¦¬ì  ì‚­ì œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë°ì´í„° ì €ì¥ì†Œ ì—”ì§„ì˜ ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ë˜ëŒë¦´ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, SQL ê¸°ë°˜ ë°ì´í„°ë² ì´ìŠ¤ëŠ” `DELETE` ë¬¸ì„ ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸”ì—ì„œ ë ˆì½”ë“œë¥¼ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì‹¤ìˆ˜ë¡œ `WHERE` ì ˆì„ ìŠì–´ë²„ë¦° ì ì´ ìˆë‹¤ë©´ ì† ë“¤ì–´ ë³´ì„¸ìš”).

```sql
DELETE FROM dbo.Movies
WHERE Movies.Id = '1'
```

ë°˜ëŒ€ë¡œ, ì†Œí”„íŠ¸ ì‚­ì œëŠ” ê°œë°œ íŒ€ì´ ì¿¼ë¦¬ ì¤‘ì— ë¬´ì‹œí•  ë ˆì½”ë“œë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•´ ë‚´ë¦° ë…¼ë¦¬ì  ê²°ì •ì…ë‹ˆë‹¤. ë°ì´í„° ëª¨ë¸ì˜ ë£¨íŠ¸ ìš”ì†Œì—ëŠ” ì‚­ì œ ì‹œê°„ì„ ë‚˜íƒ€ë‚´ëŠ” ë¶€ìš¸ í”Œë˜ê·¸ ë˜ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ì™€ ê°™ì€ ì¼ì¢…ì˜ í”Œë˜ê·¸ê°€ ìˆìŠµë‹ˆë‹¤. ë£¨íŠ¸ ìš”ì†Œì— ì ìš©ë˜ëŠ” ì¿¼ë¦¬ëŠ” ì‚­ì œ í‘œì‹œê¸°ë¥¼ ê²°ê³¼ ì§‘í•©ì„ ìƒì„±í•˜ëŠ” ìš”ì†Œë¡œ ì‚¬ìš©í• ì§€ ì—¬ë¶€ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒì€ ë ˆì½”ë“œë¥¼ ë°˜í™˜í•˜ëŠ” SQL ì¿¼ë¦¬ì´ì§€ë§Œ `IsDeleted` ë¹„íŠ¸ ì—´ì´ "false"ì— ëŒ€í•´ 0ìœ¼ë¡œ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ ë ˆì½”ë“œë¥¼ ë°˜í™˜í•˜ëŠ” ì¿¼ë¦¬ì…ë‹ˆë‹¤.

```sql
SELECT * FROM dbo.Movies
WHERE Movies.Id = '1' AND Movies.IsDeleted = 0
```

ë‹¹ì‹  ë˜ëŠ” ë‹¹ì‹ ì˜ ê³ ê°ì´ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ë ¤ëŠ” ê²½ìš° ì‚­ì œ í‘œì‹œê¸°ì˜ ê°’ì„ ë³€ê²½í•˜ëŠ” ê²ƒë§Œí¼ì´ë‚˜ ê°„ë‹¨í•˜ê²Œ ì‚­ì œëœ ë°ì´í„°ë¥¼ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
UPDATE Movies
SET Movies.IsDeleted = 0
WHERE Id = '1';
```

ì†Œí”„íŠ¸ ì‚­ì œ ë§ˆì»¤ëŠ” ì‚­ì œ í‘œì‹œê¸°ë¥¼ ì ìš©í•  ì‹œê¸°ì™€ ìœ„ì¹˜ë¥¼ ê³ ë ¤í•´ì•¼ í•˜ë¯€ë¡œ ê¸°ì¡´ ì‹œìŠ¤í…œì— êµ¬í˜„í•˜ê¸°ê°€ ë” ì–´ë µìŠµë‹ˆë‹¤. ë˜í•œ ì¶”ê°€ ì¸ë±ìŠ¤ì™€ ë ˆì½”ë“œ ìˆ˜ ì¦ê°€ë¡œ ì¸í•´ ì•½ê°„ì˜ ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë””ìŠ¤í¬ ê³µê°„ì´ë‚˜ I/O ì œí•œì´ ìˆëŠ” ê²½ìš° ì´ëŸ¬í•œ ë‹¨ì ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ì œ **ì†Œí”„íŠ¸ ì‚­ì œ** ì „ëµì˜ êµ¬ì„± ìš”ì†Œì— ëŒ€í•œ ì¼ë°˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ì–»ì—ˆìœ¼ë¯€ë¡œ, Entity Framework Coreë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.

## ì¸í„°ì…‰í„°ë¥¼ ì‚¬ìš©í•œ ì—”í‹°í‹° í”„ë ˆì„ì›Œí¬ ì†Œí”„íŠ¸ ì‚­ì œ

ì—”í‹°í‹° í”„ë ˆì„ì›Œí¬ ì½”ì–´ì—ëŠ” ì‹¤í–‰ íŒŒì´í”„ë¼ì¸ì„ í™•ì¥í•˜ëŠ” ì ‘ê·¼ ë°©ì‹ì¸ **ì¸í„°ì…‰í„°ë¼**ëŠ” ê°œë…ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¸í„°ì…‰í„°ì—ëŠ” ì—¬ëŸ¬ ê°€ì§€ ìœ í˜•ì´ ìˆìœ¼ë©°, í‘œì¤€ êµ¬í˜„ì„ í†µí•´ SQL ëª…ë ¹ì„ ìˆ˜ì •í•˜ê³ , ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•˜ê¸° ì „ì— ì—”í‹°í‹°ë¥¼ ë³€ê²½í•˜ê³ , ê°ì‚¬ ê¸°ìˆ ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì˜ˆì œì—ì„œëŠ” ì¸í„°ì…‰í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‘ì„± ë‹¨ê³„ì—ì„œ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤. ë¨¼ì € ì†Œí”„íŠ¸ ì‚­ì œë¥¼ ì§€ì›í•˜ë„ë¡ ì¡°ì •í•  `Movie` ì—”í‹°í‹°ë¥¼ ì •ì˜í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```csharp
public class Movie 
{
    public int Id { get; set; }
    public string Title { get; set; } = "";
    public string Writer { get; set; } = "";
    public string Director { get; set; } = "";
    public int ReleaseYear { get; set; }
    
    public override string ToString()
        => $"{Id}: {Title} ({ReleaseYear})";
}
```

ì¬ì‚¬ìš©ì„ ëŠ˜ë¦¬ê¸° ìœ„í•´ `ISoftDelete` ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ ê³µìœ  í”„ë¡œí¼í‹°ì™€ ì‚­ì œ ì·¨ì†Œë¥¼ ìœ„í•œ êµ¬í˜„ì„ ì œê³µí•˜ê² ìŠµë‹ˆë‹¤. ì†Œí”„íŠ¸ ì‚­ì œ ì „ëµì—ëŠ” `IsDeleted` ë˜ëŠ” `DeletedAt` ì†ì„± ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©í•´ë„ ì¶©ë¶„í•˜ì§€ë§Œ, ì´ ì˜ˆì œì—ì„œëŠ” ìµœëŒ€í•œ ìƒì„¸í•˜ê²Œ ì„¤ëª…í•˜ê¸° ìœ„í•´ ë‘ ê°€ì§€ ì†ì„±ì„ ëª¨ë‘ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ì´ ì†Œí”„íŠ¸ ì‚­ì œ ì ‘ê·¼ ë°©ì‹ì„ ì±„íƒí•˜ë ¤ëŠ” ê²½ìš° ì´ëŸ¬í•œ ì†ì„± ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

```csharp
public interface ISoftDelete
{
    public bool IsDeleted { get; set; }
    public DateTimeOffset? DeletedAt { get; set; }
    public void Undo()
    {
        IsDeleted = false;
        DeletedAt = null;
    }
}
```

ì¸í„°í˜ì´ìŠ¤ë¥¼ `Movie` ì—”í‹°í‹°ì— ì ìš©í•˜ê³  ìµœì¢… ì—”í‹°í‹° ì •ì˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

```csharp
public class Movie : ISoftDelete
{
    public int Id { get; set; }
    public string Title { get; set; } = "";
    public string Writer { get; set; } = "";
    public string Director { get; set; } = "";
    public int ReleaseYear { get; set; }
    
    public override string ToString()
        => $"{Id}: {Title} ({ReleaseYear})";
    public bool IsDeleted { get; set; }
    public DateTimeOffset? DeletedAt { get; set; }
}
```

ì‚­ì œí•˜ë ¤ëŠ” ëª¨ë“  ì—”í‹°í‹°ì— ì‚­ì œ í”Œë˜ê·¸ë¥¼ ì„¤ì •í•  ìˆ˜ë„ ìˆì§€ë§Œ, ê·¸ë ‡ê²Œ í•˜ë©´ ì§€ë£¨í•  ë¿ ì•„ë‹ˆë¼ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê¸° ì‰½ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ EF ì½”ì–´ ì¸í”„ë¼ë¥¼ í™œìš©í•˜ì—¬ `SoftDeleteInterceptor`ë¥¼ ì‘ì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Diagnostics;
public class SoftDeleteInterceptor : SaveChangesInterceptor
{
    public override InterceptionResult<int> SavingChanges(
        DbContextEventData eventData, 
        InterceptionResult<int> result)
    {
        if (eventData.Context is null) return result;
        
        foreach (var entry in eventData.Context.ChangeTracker.Entries())
        {
            if (entry is not { State: EntityState.Deleted, Entity: ISoftDelete delete }) continue;
            entry.State = EntityState.Modified;
            delete.IsDeleted = true;
            delete.DeletedAt = DateTimeOffset.UtcNow;
        }
        return result;
    }
}
```

`DbContext` ì¸ìŠ¤í„´ìŠ¤ì—ì„œ `SaveChanges`ë¥¼ í˜¸ì¶œí•˜ë©´ ì´ ì¸í„°ì…‰í„°ëŠ” ë³€ê²½ ì¶”ì ê¸°ì˜ í•­ëª©ì´ `ISoftDelete`ë¥¼ êµ¬í˜„í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ì¸í„°ì…‰í„°ëŠ” ì—”í‹°í‹° ìƒíƒœë¥¼ `Deleted`(ì‚­ì œë¨)ì—ì„œ `Modified`(ìˆ˜ì •ë¨)ë¡œ ë³€ê²½í•˜ê³  ëª¨ë“  ì†Œí”„íŠ¸ ì‚­ì œ ì†ì„±ì„ ì„¤ì •í•©ë‹ˆë‹¤.

êµ¬í˜„ì—ì„œ ë³¼ ìˆ˜ ìˆë“¯ì´ ì´ ì¸í„°ì…‰í„°ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë³„ ê¸°ëŠ¥ì„ í˜¸ì¶œí•˜ê¸° ì „ì— EF ì½”ì–´ êµ¬ì¡°ì²´ì™€ í•¨ê»˜ ì‘ë™í•©ë‹ˆë‹¤. ì´ ì¸í„°ì…‰í„°ëŠ” SQL Server, PostgreSQL, SQLite ë° MySQLì„ í¬í•¨í•˜ë˜ ì´ì— êµ­í•œë˜ì§€ ì•ŠëŠ” EF Coreì—ì„œ ì§€ì›í•˜ëŠ” ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ê³µê¸‰ìì™€ í•¨ê»˜ ì‘ë™í•©ë‹ˆë‹¤. ì´ ìƒ˜í”Œì—ì„œëŠ” `Microsoft.EntityFrameworkCore.InMemory` íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í–ˆì§€ë§Œ ì›í•˜ëŠ” ê³µê¸‰ìë¡œ ììœ ë¡­ê²Œ ëŒ€ì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì“°ê¸° ë‹¨ê³„ ìˆ˜ì •ì„ ì™„ë£Œí•˜ëŠ” ë§ˆì§€ë§‰ ë‹¨ê³„ëŠ” ì´ˆê¸°í™”ì˜ `OnConfiguring` ë‹¨ê³„ì—ì„œ `AddInterceptors` í˜¸ì¶œì„ ì‚¬ìš©í•˜ì—¬ ì¸í„°ì…‰í„°ë¥¼ `DbContext` ì •ì˜ë¡œ ë“±ë¡í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

```csharp
using Microsoft.EntityFrameworkCore;
public class Database : DbContext
{
    public DbSet<Movie> Movies => Set<Movie>();
    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        => optionsBuilder
            .UseInMemoryDatabase("test")
            .AddInterceptors(new SoftDeleteInterceptor());
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
    }
}
```

EF Core `DbContext`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ë ¤ê³  ì‹œë„í•˜ë©´ ì‚­ì œ ë¬¸ì—ì„œ ì—…ë°ì´íŠ¸ ë¬¸ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤. ì´ì œ ì‹¤ì œë¡œ ì‘ë™í•˜ëŠ” ëª¨ìŠµì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```csharp
var db = new Database();
var firstMovie = db.Movies.First();

Console.WriteLine($"{firstMovie.Title} ({firstMovie.ReleaseYear})");

// delete operation (actually an update)
db.Movies.Remove(firstMovie);
db.SaveChanges();
Console.WriteLine($"Deleted \"{firstMovie}\"");
```

ì´ë¯¸ ëˆˆì¹˜ì±„ì…¨ê² ì§€ë§Œ, ì½”ë“œëŠ” ê¸°ì¡´ì˜ EF ì½”ì–´ì™€ ë¹„ìŠ·í•´ ë³´ì…ë‹ˆë‹¤. ë°ì´í„° ì½ê¸°ëŠ” ì–´ë–¨ê¹Œìš”? ì‚­ì œëœ ë ˆì½”ë“œë¥¼ ì–´ë–»ê²Œ í•„í„°ë§í• ê¹Œìš”? ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ê·¸ ë°©ë²•ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

## ìë™ìœ¼ë¡œ ì†Œí”„íŠ¸ ì‚­ì œëœ ë ˆì½”ë“œ í•„í„°ë§

ì‚­ì œí•  ë ˆì½”ë“œë¥¼ í‘œì‹œí•˜ëŠ” ê²ƒì€ ì ˆë°˜ì˜ ì´ì•¼ê¸°ì¼ ë¿ì…ë‹ˆë‹¤. ë‹¨ì¼ êµ¬ì„±ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œ ì†Œí”„íŠ¸ ì‚­ì œëœ ë ˆì½”ë“œë¥¼ ë¬´ì‹œí•˜ë„ë¡ EF Coreì— ì§€ì‹œí•  ìˆ˜ ìˆìœ¼ë©°, ì—”í‹°í‹° ì •ì˜ì— **ì¿¼ë¦¬ í•„í„°**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `Movies` ì»¬ë ‰ì…˜ì— ì¿¼ë¦¬ í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì •ëœ `DbContext` ì •ì˜ëŠ” ì—¬ê¸°ì— ìˆìŠµë‹ˆë‹¤.

```csharp
public class Database : DbContext
{
    public DbSet<Movie> Movies => Set<Movie>();
    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        => optionsBuilder
            .UseInMemoryDatabase("test")
            .AddInterceptors(new SoftDeleteInterceptor());
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Automatically adding query filter to 
        // all LINQ queries that use Movie
        modelBuilder.Entity<Movie>()
            .HasQueryFilter(x => x.IsDeleted == false);
    }
}
```

ì¿¼ë¦¬ í•„í„°ëŠ” ì›í•˜ëŠ” ë§Œí¼ ì ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ì¿¼ë¦¬ í•„í„°ëŠ” ì¼ë°˜ì ìœ¼ë¡œ LINQ ì¿¼ë¦¬ì—ì„œ ë³´ì´ì§€ ì•Šìœ¼ë¯€ë¡œ í•„ìš”í•œ ë§Œí¼ë§Œ ì œí•œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì¿¼ë¦¬ í•„í„°ì˜ 'ë³´ì´ì§€ ì•ŠëŠ”' íŠ¹ì„±ì€ íŒ€ì˜ ê°œë°œìê°€ ì´ëŸ¬í•œ ê°œë…ì„ ì´í•´í•˜ê³  ê´€ë¦¬í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. í•„í„°ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ í˜¼ë€ìŠ¤ëŸ¬ì›Œì§€ê³  ì˜ˆê¸°ì¹˜ ì•Šì€ ë²„ê·¸ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì½ê¸° ë° ì“°ê¸°ë¡œ ëª¨ë“  ê²ƒì„ í†µí•©í•˜ê¸°

ì•„ë˜ì— ê°„ë‹¨í•œ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë§Œë“¤ì—ˆëŠ”ë°, ì´ì „ ì„¹ì…˜ì˜ `DbContext`ë¥¼ ê³ ë ¤í•  ë•Œ ì˜ˆìƒí•  ìˆ˜ ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.

```csharp
using Microsoft.EntityFrameworkCore;
using SoftDeletes.Models;

// save test data of movies
Movies.Initialize();

var db = new Database();
var firstMovie = db.Movies.First();

Console.WriteLine($"{firstMovie.Title} ({firstMovie.ReleaseYear})");

// delete operation
db.Movies.Remove(firstMovie);
db.SaveChanges();
Console.WriteLine($"Deleted \"{firstMovie}\"");

Console.WriteLine($"Total Movies: {db.Movies.Count()}");
Console.WriteLine($"Total Movies (including deleted): {db.Movies.IgnoreQueryFilters().Count()}");
Console.WriteLine($"Total Deleted: {db.Movies.IgnoreQueryFilters().Count(x => x.IsDeleted)}");

public static class Movies
{
    public static readonly IReadOnlyList<Movie> All = new List<Movie> {
        new() { Id = 1, Title = "Glass Onion", Director = "Rian Johnson", Writer = "Rian Johnson", ReleaseYear = 2022 },
        new() { Id = 2, Title = "Avatar: The Way of Water", Director ="James Cameron", Writer = "James Cameron", ReleaseYear = 2022 },
        new() { Id = 3, Title = "The Shawshank Redemption", Writer = "Stephen King", Director = "Frank Darabont", ReleaseYear = 1994 },
        new() { Id = 4, Title = "Pulp Fiction", Writer = "Quentin Tarantino", Director = "Quentin Tarantino", ReleaseYear = 1994 },
        new() { Id = 5, Title = "Seven Samurai", Writer = "Akira Kurosawa", Director = "Akira Kurosawa", ReleaseYear = 1954 },
        new() { Id = 6, Title = "Gladiator", Writer = "David Franzoni", Director = "Ridley Scott", ReleaseYear = 2000 },
        new() { Id = 7, Title = "Old Boy", Writer = "Garon Tsuchiya", Director = "Park Chan-wook", ReleaseYear = 2003 },
        new() { Id = 8, Title = "A Clockwork Orange", Director = "Stanley Kubrick", Writer = "Stanley Kubrick", ReleaseYear = 1971 },
        new() { Id = 9, Title = "Metroplis", Director = "Fritz Lang", Writer = "Thea von Harbou", ReleaseYear = 1927 },
        new() { Id = 10, Title = "The Thing", Director = "John Carpenter", Writer = "Bill Lancaster", ReleaseYear = 1982 }
    };
    
    public static void Initialize()
    {
        var db = new Database();
        db.Movies.AddRange(All);
        db.SaveChanges();
    }
}
```

ì½”ë“œ ì–´ë””ì—ì„œë„ `IsDeleted` í”Œë˜ê·¸ì— ëŒ€í•œ ì–¸ê¸‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½ê¸°/ì“°ê¸° ì‚¬ìš©ì—ì„œ `ISoftDelete` ì†ì„±ì´ ì—†ëŠ” ê²ƒì€ EF Core ì¸í„°ì…‰í„°ì™€ ì¿¼ë¦¬ í•„í„°ê°€ ì†ì„±ì„ íˆ¬ëª…í•˜ê²Œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë˜í•œ ì¿¼ë¦¬ í•„í„°ë¥¼ ë¬´íš¨í™”í•˜ë ¤ë©´ ëª¨ë“  LINQ ì¿¼ë¦¬ì— `IgnoreQueryFilters`ë¥¼ ì‚¬ìš©í•˜ë©´ ì™„ì „í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ì–»ì–´ LINQ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```csharp
// after a delete
db.Movies.Count(); // 9
db.Movies.IgnoreQueryFilters().Count(); // 10
```

ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Diagnostics;

// save test data of movies
Movies.Initialize();

var db = new Database();
var firstMovie = db.Movies.First();

Console.WriteLine($"{firstMovie.Title} ({firstMovie.ReleaseYear})");

// delete operation
db.Movies.Remove(firstMovie);
db.SaveChanges();
Console.WriteLine($"Deleted \"{firstMovie}\"");

Console.WriteLine($"Total Movies: {db.Movies.Count()}");
Console.WriteLine($"Total Movies (including deleted): {db.Movies.IgnoreQueryFilters().Count()}");
Console.WriteLine($"Total Deleted: {db.Movies.IgnoreQueryFilters().Count(x => x.IsDeleted)}");

public static class Movies
{
    public static readonly IReadOnlyList<Movie> All = new List<Movie> {
        new() { Id = 1, Title = "Glass Onion", Director = "Rian Johnson", Writer = "Rian Johnson", ReleaseYear = 2022 },
        new() { Id = 2, Title = "Avatar: The Way of Water", Director ="James Cameron", Writer = "James Cameron", ReleaseYear = 2022 },
        new() { Id = 3, Title = "The Shawshank Redemption", Writer = "Stephen King", Director = "Frank Darabont", ReleaseYear = 1994 },
        new() { Id = 4, Title = "Pulp Fiction", Writer = "Quentin Tarantino", Director = "Quentin Tarantino", ReleaseYear = 1994 },
        new() { Id = 5, Title = "Seven Samurai", Writer = "Akira Kurosawa", Director = "Akira Kurosawa", ReleaseYear = 1954 },
        new() { Id = 6, Title = "Gladiator", Writer = "David Franzoni", Director = "Ridley Scott", ReleaseYear = 2000 },
        new() { Id = 7, Title = "Old Boy", Writer = "Garon Tsuchiya", Director = "Park Chan-wook", ReleaseYear = 2003 },
        new() { Id = 8, Title = "A Clockwork Orange", Director = "Stanley Kubrick", Writer = "Stanley Kubrick", ReleaseYear = 1971 },
        new() { Id = 9, Title = "Metroplis", Director = "Fritz Lang", Writer = "Thea von Harbou", ReleaseYear = 1927 },
        new() { Id = 10, Title = "The Thing", Director = "John Carpenter", Writer = "Bill Lancaster", ReleaseYear = 1982 }
    };
    
    public static void Initialize()
    {
        var db = new Database();
        db.Movies.AddRange(All);
        db.SaveChanges();
    }
}

public class SoftDeleteInterceptor : SaveChangesInterceptor
{
    public override InterceptionResult<int> SavingChanges(
        DbContextEventData eventData, 
        InterceptionResult<int> result)
    {
        if (eventData.Context is null) return result;
        
        foreach (var entry in eventData.Context.ChangeTracker.Entries())
        {
            if (entry is not { State: EntityState.Deleted, Entity: ISoftDelete delete }) continue;

            entry.State = EntityState.Modified;
            delete.IsDeleted = true;
            delete.DeletedAt = DateTimeOffset.UtcNow;
        }

        return result;
    }
}

public class Database : DbContext
{
    public DbSet<Movie> Movies => Set<Movie>();

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        => optionsBuilder
            .UseInMemoryDatabase("test")
            .AddInterceptors(new SoftDeleteInterceptor());

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Movie>()
            .HasQueryFilter(x => x.IsDeleted == false);
    }
}

public class Movie : ISoftDelete
{
    public int Id { get; set; }
    public string Title { get; set; } = "";
    public string Writer { get; set; } = "";
    public string Director { get; set; } = "";
    public int ReleaseYear { get; set; }
    
    public override string ToString()
        => $"{Id}: {Title} ({ReleaseYear})";

    public bool IsDeleted { get; set; }
    public DateTimeOffset? DeletedAt { get; set; }
}

public interface ISoftDelete
{
    public bool IsDeleted { get; set; }
    public DateTimeOffset? DeletedAt { get; set; }

    public void Undo()
    {
        IsDeleted = false;
        DeletedAt = null;
    }
}
```

ìœ„ì˜ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¶œë ¥ì´ í‘œì‹œë©ë‹ˆë‹¤.

```bash
Glass Onion (2022)
Deleted "1: Glass Onion (2022)"
Total Movies: 9
Total Movies (including deleted): 10
Total Deleted: 1
```

ì´ì „ ë²„ì „ì— ë¹„í•´ EF Coreë¥¼ ì‚¬ìš©í•˜ë©´ í›¨ì”¬ ë” ê°„ë‹¨í•˜ê³  ì‰½ê²Œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°ì´í„°ëŠ” ë¬¼ë¦¬ì ìœ¼ë¡œ ì‚­ì œë˜ì§€ ì•Šê³  ë…¼ë¦¬ì ìœ¼ë¡œë§Œ 'ì‚­ì œ'ëœë‹¤ëŠ” ì ì„ ë‹¤ì‹œ í•œ ë²ˆ ìƒê¸°ì‹œì¼œ ë“œë¦½ë‹ˆë‹¤. ì—”í‹°í‹°ë¥¼ ì‚½ì…/ì‚­ì œí•˜ëŠ” ì½”ë“œëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€ë˜ë©° ì¿¼ë¦¬ ë˜í•œ ì¼ìƒì ì¸ EF ì¿¼ë¦¬ì™€ í¬ê²Œ ë‹¤ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ ëª¨ë“  ê²ƒì´ EF ì¸í„°ì…‰í„°ì˜ í˜ ë•ë¶„ì…ë‹ˆë‹¤.

## ê²°ë¡ 

ì†Œí”„íŠ¸ ì‚­ì œ ì „ëµì„ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ë¥¼ ì¹˜ëª…ì ìœ¼ë¡œ íŒŒê´´í•  ìœ„í—˜ ì—†ì´ ì˜ë„í•œ ì‚¬ìš©ì ê²½í—˜ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¸°ë²•ì—ëŠ” ì•½ê°„ì˜ ì˜¤ë²„í—¤ë“œê°€ ìˆì§€ë§Œ, EF Core ì¸í”„ë¼ì™€ ê°„ë‹¨í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ ê·¹ë³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¿¼ë¦¬ ì†ë„ë¥¼ ë†’ì´ë ¤ë©´ í…Œì´ë¸”ì— ì‚­ì œ í”Œë˜ê·¸ì— ëŒ€í•œ ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ë˜í•œ ì¿¼ë¦¬ í•„í„°ì™€ ì¸í„°ì…‰í„°ë¥¼ ë‹¤ë¥¸ ë¬¸ì œì—ë„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ì‘ì—…ì„ í•´ê²°í•˜ê¸° ìœ„í•œ ë‹¤ì–‘í•œ ì ‘ê·¼ ë°©ì‹ì„ ì‚´í´ë³¼ ë•Œ ì¢‹ì€ ì§€ì‹ì…ë‹ˆë‹¤.

ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦¬ë©°, ì˜ê²¬ì´ë‚˜ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ëŒ“ê¸€ ì„¹ì…˜ì— ë‚¨ê²¨ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

---

%[https://blog.jetbrains.com/dotnet/2023/06/14/how-to-implement-a-soft-delete-strategy-with-entity-framework-core/]